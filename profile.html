<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title>TechCloud - Profile</title>
		<!-- Description, Keywords and Author -->
		<meta name="description" content="Your TechCloud profile">
		<meta name="keywords" content="TechCloud,Profile,User">
		<meta name="author" content="TechCloud">
		
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		
		<!-- Styles -->
		<!-- Bootstrap CSS -->
		<link href="css/bootstrap.min.css" rel="stylesheet">
		<!-- Font awesome CSS -->
		<link href="css/font-awesome.min.css" rel="stylesheet">		
		<!-- Custom CSS -->
		<link href="css/style.css" rel="stylesheet">
		
		<!-- Supabase -->
		<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
		
		<!-- Favicon -->
		<link rel="shortcut icon" href="#">
	</head>
	
	<body>
	
		<div class="wrapper">
		
			<!-- header -->
			<header>
				<!-- navigation -->
				<nav class="navbar navbar-default" role="navigation">
					<div class="container">
						<!-- Brand and toggle get grouped for better mobile display -->
						<div class="navbar-header">
							<button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
								<span class="sr-only">Toggle navigation</span>
								<span class="icon-bar"></span>
								<span class="icon-bar"></span>
								<span class="icon-bar"></span>
							</button>
							<a class="navbar-brand" href="index.html"><img class="img-responsive" src="img/logo.png" alt="Logo" /></a>
						</div>

						<!-- Collect the nav links, forms, and other content for toggling -->
						<div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
							<ul class="nav navbar-nav navbar-right">
								<!-- Auth Links (shown when not logged in) -->
								<li class="auth-links"><a href="registration.html">Signup</a></li>
								<li class="auth-links"><a href="login.html">Login</a></li>
								
								<!-- User Info (shown when logged in) -->
								<li class="dropdown user-info" style="display: none;">
									<a href="#" class="dropdown-toggle" data-toggle="dropdown">
										<i class="fa fa-user"></i> <span class="user-name">User</span> <span class="caret"></span>
									</a>
									<ul class="dropdown-menu" role="menu">
										<li><a href="profile.html"><i class="fa fa-user"></i> Profile</a></li>
										<li><a href="dashboard.html"><i class="fa fa-dashboard"></i> Dashboard</a></li>
										<li class="divider"></li>
										<li><a href="#" id="logoutBtn"><i class="fa fa-sign-out"></i> Logout</a></li>
									</ul>
								</li>
								
								<li><a href="index.html">Home</a></li>
							</ul>
						</div><!-- /.navbar-collapse -->
					</div><!-- /.container-fluid -->
				</nav>
			</header>
			
			<!-- banner -->
			<div class="banner">
				<div class="container">
					<div class="row">
						<div class="col-md-8 col-md-offset-2">
							<!-- Profile content -->
							<div class="profile-area">
								<!-- heading -->
								<h3><i class="fa fa-user"></i> User Profile</h3>
								
								<!-- Profile Info -->
								<div class="panel panel-default">
									<div class="panel-heading">
										<h4>Profile Information</h4>
									</div>
									<div class="panel-body">
										<div class="row">
											<div class="col-md-6">
												<div class="form-group">
													<label>Full Name:</label>
													<p class="form-control-static" id="profileFullName">Loading...</p>
												</div>
											</div>
											<div class="col-md-6">
												<div class="form-group">
													<label>Email:</label>
													<p class="form-control-static" id="profileEmail">Loading...</p>
												</div>
											</div>
										</div>
										<div class="row">
											<div class="col-md-6">
												<div class="form-group">
													<label>Member Since:</label>
													<p class="form-control-static" id="profileMemberSince">Loading...</p>
												</div>
											</div>
											<div class="col-md-6">
												<div class="form-group">
													<label>Last Login:</label>
													<p class="form-control-static" id="profileLastLogin">Loading...</p>
												</div>
											</div>
										</div>
									</div>
								</div>
								
								<!-- Update Profile Form -->
								<div class="panel panel-default">
									<div class="panel-heading">
										<h4>Update Profile</h4>
									</div>
									<div class="panel-body">
										<form id="updateProfileForm">
											<div class="form-group">
												<label for="updateFullName">Full Name:</label>
												<input type="text" class="form-control" id="updateFullName" placeholder="Enter your full name">
											</div>
											<button type="submit" class="btn btn-primary" id="updateProfileBtn">
												<span class="btn-text">Update Profile</span>
												<span class="btn-loading" style="display: none;">
													<i class="fa fa-spinner fa-spin"></i> Updating...
												</span>
											</button>
										</form>
									</div>
								</div>
								
								<!-- Change Password Form -->
								<div class="panel panel-default">
									<div class="panel-heading">
										<h4>Change Password</h4>
									</div>
									<div class="panel-body">
										<form id="changePasswordForm">
											<div class="form-group">
												<label for="newPassword">New Password:</label>
												<input type="password" class="form-control" id="newPassword" placeholder="Enter new password" minlength="6">
											</div>
											<div class="form-group">
												<label for="confirmNewPassword">Confirm New Password:</label>
												<input type="password" class="form-control" id="confirmNewPassword" placeholder="Confirm new password">
											</div>
											<button type="submit" class="btn btn-warning" id="changePasswordBtn">
												<span class="btn-text">Change Password</span>
												<span class="btn-loading" style="display: none;">
													<i class="fa fa-spinner fa-spin"></i> Changing...
												</span>
											</button>
										</form>
									</div>
								</div>
								
								<!-- Danger Zone -->
								<div class="panel panel-danger">
									<div class="panel-heading">
										<h4>Danger Zone</h4>
									</div>
									<div class="panel-body">
										<p>Once you delete your account, there is no going back. Please be certain.</p>
										<button type="button" class="btn btn-danger" id="deleteAccountBtn">
											<i class="fa fa-trash"></i> Delete Account
										</button>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
			<!-- banner end -->
			
			<!-- footer -->
			<footer class="ffoot">
				<div class="container">
					<p><a href="index.html">Home</a> | <a href="#work">works</a> | <a href="#team">Team</a> | <a href="#contact">Contact</a></p>
					<div class="social">
						<a href="#"><i class="fa fa-facebook"></i></a>
						<a href="#"><i class="fa fa-twitter"></i></a>
						<a href="#"><i class="fa fa-dribbble"></i></a>
						<a href="#"><i class="fa fa-linkedin"></i></a>
						<a href="#"><i class="fa fa-google-plus"></i></a>
					</div>
				</div>
			</footer>

		</div>
		
		
		<!-- Javascript files -->
		<!-- jQuery -->
		<script src="js/jquery.js"></script>
		<!-- Bootstrap JS -->
		<script src="js/bootstrap.min.js"></script>
		<!-- Respond JS for IE8 -->
		<script src="js/respond.min.js"></script>
		<!-- HTML5 Support for IE -->
		<script src="js/html5shiv.js"></script>
		<!-- Supabase Config -->
		<script src="js/supabase-config.js"></script>
		<!-- Session Manager -->
		<script src="js/session-manager.js"></script>
		<!-- Auth Module -->
		<script src="js/auth.js"></script>
		<!-- Custom JS -->
		<script src="js/custom.js"></script>
		
		<!-- Profile Page Script -->
		<script>
			document.addEventListener('DOMContentLoaded', async function() {
				try {
					// Show loading state
					const loadingDiv = document.createElement('div');
					loadingDiv.id = 'profile-loading';
					loadingDiv.className = 'text-center';
					loadingDiv.style.cssText = 'padding: 50px; font-size: 16px;';
					loadingDiv.innerHTML = '<i class="fa fa-spinner fa-spin"></i> Loading profile...';
					
					const container = document.querySelector('.container');
					if (container) {
						container.insertBefore(loadingDiv, container.firstChild);
					}
					
					// Require authentication (now async)
					const isAuthenticated = await authManager.requireAuth();
					if (!isAuthenticated) {
						return;
					}
					
					const user = await authManager.getCurrentUser();
					
					if (!user) {
						authManager.showMessage('Failed to load user profile', 'error');
						setTimeout(() => {
							window.location.href = 'login.html';
						}, 2000);
						return;
					}
					
					// Remove loading state
					if (loadingDiv.parentElement) {
						loadingDiv.remove();
					}
					
					// Populate profile information
					document.getElementById('profileFullName').textContent = user.user_metadata?.full_name || 'Not set';
					document.getElementById('profileEmail').textContent = user.email;
					document.getElementById('profileMemberSince').textContent = new Date(user.created_at).toLocaleDateString();
					document.getElementById('profileLastLogin').textContent = new Date(user.last_sign_in_at || user.created_at).toLocaleDateString();
					
					// Pre-fill update form
					document.getElementById('updateFullName').value = user.user_metadata?.full_name || '';
					
				} catch (error) {
					console.error('Profile page initialization error:', error);
					authManager.showMessage('Failed to initialize profile page', 'error');
					setTimeout(() => {
						window.location.href = 'login.html';
					}, 2000);
					return;
				}
				
				// Handle profile update
				const updateProfileForm = document.getElementById('updateProfileForm');
				const updateProfileBtn = document.getElementById('updateProfileBtn');
				const updateBtnText = updateProfileBtn.querySelector('.btn-text');
				const updateBtnLoading = updateProfileBtn.querySelector('.btn-loading');
				
				updateProfileForm.addEventListener('submit', async function(e) {
					e.preventDefault();
					
					const fullName = document.getElementById('updateFullName').value;
					
					if (!fullName) {
						authManager.showMessage('Please enter your full name', 'error');
						return;
					}
					
					// Show loading state
					updateBtnText.style.display = 'none';
					updateBtnLoading.style.display = 'inline';
					updateProfileBtn.disabled = true;
					
					try {
						const { error } = await supabaseClient.auth.updateUser({
							data: { full_name: fullName }
						});
						
						if (error) throw error;
						
						// Update displayed name
						document.getElementById('profileFullName').textContent = fullName;
						authManager.showMessage('Profile updated successfully!', 'success');
						
					} catch (error) {
						console.error('Update profile error:', error);
						authManager.showMessage(error.message, 'error');
					}
					
					// Reset button state
					updateBtnText.style.display = 'inline';
					updateBtnLoading.style.display = 'none';
					updateProfileBtn.disabled = false;
				});
				
				// Handle password change
				const changePasswordForm = document.getElementById('changePasswordForm');
				const changePasswordBtn = document.getElementById('changePasswordBtn');
				const changeBtnText = changePasswordBtn.querySelector('.btn-text');
				const changeBtnLoading = changePasswordBtn.querySelector('.btn-loading');
				
				changePasswordForm.addEventListener('submit', async function(e) {
					e.preventDefault();
					
					const newPassword = document.getElementById('newPassword').value;
					const confirmNewPassword = document.getElementById('confirmNewPassword').value;
					
					if (!newPassword || !confirmNewPassword) {
						authManager.showMessage('Please fill in all password fields', 'error');
						return;
					}
					
					if (newPassword !== confirmNewPassword) {
						authManager.showMessage('Passwords do not match', 'error');
						return;
					}
					
					if (newPassword.length < 6) {
						authManager.showMessage('Password must be at least 6 characters long', 'error');
						return;
					}
					
					// Show loading state
					changeBtnText.style.display = 'none';
					changeBtnLoading.style.display = 'inline';
					changePasswordBtn.disabled = true;
					
					try {
						const { error } = await supabaseClient.auth.updateUser({
							password: newPassword
						});
						
						if (error) throw error;
						
						// Clear form
						changePasswordForm.reset();
						authManager.showMessage('Password changed successfully!', 'success');
						
					} catch (error) {
						console.error('Change password error:', error);
						authManager.showMessage(error.message, 'error');
					}
					
					// Reset button state
					changeBtnText.style.display = 'inline';
					changeBtnLoading.style.display = 'none';
					changePasswordBtn.disabled = false;
				});
				
				// Handle logout
				const logoutBtn = document.getElementById('logoutBtn');
				if (logoutBtn) {
					logoutBtn.addEventListener('click', async function(e) {
						e.preventDefault();
						await authManager.signOut();
					});
				}
				
				// Handle account deletion (placeholder - would need additional confirmation)
				const deleteAccountBtn = document.getElementById('deleteAccountBtn');
				deleteAccountBtn.addEventListener('click', function(e) {
					e.preventDefault();
					if (confirm('Are you absolutely sure you want to delete your account? This action cannot be undone.')) {
						authManager.showMessage('Account deletion feature would be implemented here with proper safeguards', 'info');
					}
				});
			});
		</script>
	</body>	
</html>
